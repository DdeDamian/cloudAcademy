{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Metadata": {
        "AWS::CloudFormation::Designer": {
            "43b2730c-693d-48c2-9359-3266444b6c8a": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 290,
                    "y": 370
                },
                "z": 0,
                "embeds": [],
                "ismemberof": [
                    "59948518-12eb-4a3a-af2d-9c6e1ff4e3d4",
                    "4964b1a1-0628-4a84-abb8-73eff1623d11"
                ]
            },
            "b24634d9-5f12-432c-8c31-cef6a5fa5fff": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 30,
                    "y": 270
                },
                "z": 0,
                "embeds": []
            },
            "4964b1a1-0628-4a84-abb8-73eff1623d11": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 430,
                    "y": 370
                },
                "z": 0,
                "embeds": []
            },
            "59948518-12eb-4a3a-af2d-9c6e1ff4e3d4": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 430,
                    "y": 270
                },
                "z": 0,
                "embeds": []
            },
            "f3c05c9e-c399-4df9-a081-e70da26ba56a": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 540,
                    "y": 480
                },
                "z": 0,
                "embeds": []
            },
            "f13b227d-b203-44ff-8367-da29e0eeaa6b": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 430,
                    "y": 480
                },
                "z": 0,
                "embeds": [],
                "ismemberof": [
                    "f3c05c9e-c399-4df9-a081-e70da26ba56a"
                ]
            },
            "183c4711-f0de-4079-a4e0-e42982265be9": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 290,
                    "y": 480
                },
                "z": 0,
                "embeds": []
            },
            "34759181-8d99-4333-86c1-4fde1b23c828": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 290,
                    "y": 60
                },
                "z": 0,
                "embeds": []
            },
            "ac54816f-1dab-4c9d-8b19-808f6881775f": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 430,
                    "y": 170
                },
                "z": 0,
                "embeds": []
            },
            "8a2a2d4e-3ae0-4e90-8953-5bec2b66ab4d": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 30,
                    "y": 170
                },
                "z": 0,
                "embeds": []
            },
            "6f155d29-5d5b-4cd4-928a-304368cf1260": {
                "source": {
                    "id": "43b2730c-693d-48c2-9359-3266444b6c8a"
                },
                "target": {
                    "id": "59948518-12eb-4a3a-af2d-9c6e1ff4e3d4"
                },
                "z": 1
            },
            "c1d9c858-cc28-460e-8834-8319cc6fbb9c": {
                "source": {
                    "id": "03d89554-2b17-42a3-a2cd-d79073dae91a"
                },
                "target": {
                    "id": "4964b1a1-0628-4a84-abb8-73eff1623d11"
                },
                "z": 2
            },
            "6c6802c2-7354-4a06-807e-212a2ed39da9": {
                "source": {
                    "id": "d369cd72-7a8c-4ac0-bdaf-5d1b150b3a1f"
                },
                "target": {
                    "id": "ac54816f-1dab-4c9d-8b19-808f6881775f"
                },
                "z": 11
            },
            "b7c02847-5d05-464f-9dfa-1289a70299fe": {
                "source": {
                    "id": "f13b227d-b203-44ff-8367-da29e0eeaa6b"
                },
                "target": {
                    "id": "f3c05c9e-c399-4df9-a081-e70da26ba56a"
                },
                "z": 12
            },
            "2f57fed2-22be-4ec6-aa70-7cb7475efba2": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 170,
                    "y": 170
                },
                "z": 0,
                "embeds": [],
                "isconnectedto": [
                    "8a2a2d4e-3ae0-4e90-8953-5bec2b66ab4d"
                ],
                "isassociatedwith": [
                    "88aab4af-cd47-490a-b967-e5c211766512"
                ]
            },
            "18415ed8-aeb7-407c-9ca1-b279130d9c27": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 170,
                    "y": 270
                },
                "z": 0,
                "embeds": [],
                "isconnectedto": [
                    "b24634d9-5f12-432c-8c31-cef6a5fa5fff"
                ],
                "isassociatedwith": [
                    "8c11f7cc-2d22-4f59-9019-f78aa5365107"
                ]
            },
            "88aab4af-cd47-490a-b967-e5c211766512": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 290,
                    "y": 170
                },
                "z": 0,
                "embeds": [],
                "ismemberof": [
                    "ac54816f-1dab-4c9d-8b19-808f6881775f"
                ]
            },
            "8c11f7cc-2d22-4f59-9019-f78aa5365107": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 290,
                    "y": 270
                },
                "z": 0,
                "embeds": [],
                "ismemberof": [
                    "4964b1a1-0628-4a84-abb8-73eff1623d11",
                    "59948518-12eb-4a3a-af2d-9c6e1ff4e3d4"
                ]
            },
            "186bec7d-bf04-4167-93fe-d4a69fed0582": {
                "source": {
                    "id": "88aab4af-cd47-490a-b967-e5c211766512"
                },
                "target": {
                    "id": "ac54816f-1dab-4c9d-8b19-808f6881775f"
                },
                "z": 11
            },
            "90866fe3-28a7-43a6-803d-a5787bd02ad3": {
                "source": {
                    "id": "8c11f7cc-2d22-4f59-9019-f78aa5365107"
                },
                "target": {
                    "id": "4964b1a1-0628-4a84-abb8-73eff1623d11"
                },
                "z": 12
            },
            "8d4fda3e-d711-4bc6-9660-04a6745c7208": {
                "source": {
                    "id": "2f57fed2-22be-4ec6-aa70-7cb7475efba2"
                },
                "target": {
                    "id": "8a2a2d4e-3ae0-4e90-8953-5bec2b66ab4d"
                },
                "z": 13
            },
            "52e3ed75-5598-4b54-9775-8105ee522295": {
                "source": {
                    "id": "18415ed8-aeb7-407c-9ca1-b279130d9c27"
                },
                "target": {
                    "id": "b24634d9-5f12-432c-8c31-cef6a5fa5fff"
                },
                "z": 14
            },
            "24331fff-d919-4b3a-87cf-baabdd1489be": {
                "source": {
                    "id": "18415ed8-aeb7-407c-9ca1-b279130d9c27"
                },
                "target": {
                    "id": "8c11f7cc-2d22-4f59-9019-f78aa5365107"
                },
                "z": 15
            },
            "a9ec0785-894c-4018-8b14-d02926e60e42": {
                "source": {
                    "id": "2f57fed2-22be-4ec6-aa70-7cb7475efba2"
                },
                "target": {
                    "id": "88aab4af-cd47-490a-b967-e5c211766512"
                },
                "z": 16
            }
        }
    },
    "Parameters": {
        "VpcId": {
            "Type": "AWS::EC2::VPC::Id",
            "Description": "VpcId of our existing Virtual Private Cloud (VPC)",
            "ConstraintDescription": "must be the VPC Id of an existing Virtual Private Cloud."
        },
        "Subnets": {
            "Type": "List<AWS::EC2::Subnet::Id>",
            "Description": "The list of SubnetIds in our Virtual Private Cloud (VPC)",
            "ConstraintDescription": "must be a list of at least two existing subnets associated with at least two different availability zones. They should be residing in the selected Virtual Private Cloud."
        },
        "SSHLocation": {
            "Description": "Lockdown SSH access to the bastion host (default can be accessed from anywhere)",
            "Type": "String",
            "MinLength": "9",
            "MaxLength": "18",
            "Default": "0.0.0.0/0",
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
            "ConstraintDescription": "must be a valid CIDR range of the form x.x.x.x/x."
        },
        "KeyName": {
            "Description": "Name of an existing EC2 KeyPair to enable SSH access to the instances",
            "Type": "AWS::EC2::KeyPair::KeyName",
            "ConstraintDescription": "must be the name of an existing EC2 KeyPair."
        },
        "InstanceType": {
            "Description": "WebServer EC2 instance type",
            "Type": "String",
            "Default": "t2.micro",
            "AllowedValues": [
                "t1.micro",
                "t2.nano",
                "t2.micro",
                "t2.small",
                "m1.small",
                "m3.medium",
                "c1.medium"
            ],
            "ConstraintDescription": "must be a valid EC2 instance type."
        },
        "InstanceCount": {
            "Description": "Number of EC2 instances to launch",
            "Type": "Number",
            "Default": "1"
        }
    },
    "Resources": {
        "DataBaseSG": {
            "Type": "AWS::RDS::DBSecurityGroup",
            "Properties": {},
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "f3c05c9e-c399-4df9-a081-e70da26ba56a"
                }
            }
        },
        "DataBase": {
            "Type": "AWS::RDS::DBInstance",
            "Properties": {
                "DBSecurityGroups": [
                    {
                        "Ref": "DataBaseSG"
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "f13b227d-b203-44ff-8367-da29e0eeaa6b"
                }
            }
        },
        "OurBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {},
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "183c4711-f0de-4079-a4e0-e42982265be9"
                }
            }
        },
        "MgtBoxSG": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "22",
                        "ToPort": "22",
                        "CidrIp": {
                            "Ref": "SSHLocation"
                        }
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "4964b1a1-0628-4a84-abb8-73eff1623d11"
                }
            }
        },
        "MgtBox": {
            "Type": "AWS::EC2::Instance",
            "Properties": {
                "SecurityGroupIds": [
                    {
                        "Ref": "MgtBoxSG"
                    }
                ],
                "KeyName": {
                    "Ref": "KeyName"
                },
                "InstanceType": {
                    "Ref": "InstanceType"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "43b2730c-693d-48c2-9359-3266444b6c8a"
                }
            }
        },
        "LAMPServerSG": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "80",
                        "ToPort": "80",
                        "CidrIp": "0.0.0.0/0"
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "59948518-12eb-4a3a-af2d-9c6e1ff4e3d4"
                }
            }
        },
        "LAMPELB": {
            "Type": "AWS::ElasticLoadBalancing::LoadBalancer",
            "Properties": {
                "AvailabilityZones": {
                    "Fn::GetAZs": ""
                },
                "CrossZone": "true",
                "Listeners": [
                    {
                        "LoadBalancerPort": "80",
                        "InstancePort": "80",
                        "Protocol": "HTTP"
                    }
                ],
                "HealthCheck": {
                    "Target": "HTTP:80/",
                    "HealthyThreshold": "3",
                    "UnhealthyThreshold": "5",
                    "Interval": "30",
                    "Timeout": "5"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "b24634d9-5f12-432c-8c31-cef6a5fa5fff"
                }
            }
        },
        "FTPFS": {
            "Type": "AWS::EFS::FileSystem",
            "Properties": {},
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "34759181-8d99-4333-86c1-4fde1b23c828"
                }
            }
        },
        "FTPSG": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "21",
                        "ToPort": "21",
                        "CidrIp": "0.0.0.0/0"
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "ac54816f-1dab-4c9d-8b19-808f6881775f"
                }
            }
        },
        "FTPELB": {
            "Type": "AWS::ElasticLoadBalancing::LoadBalancer",
            "Properties": {
                "AvailabilityZones": {
                    "Fn::GetAZs": ""
                },
                "CrossZone": "true",
                "Listeners": [
                    {
                        "LoadBalancerPort": "80",
                        "InstancePort": "80",
                        "Protocol": "HTTP"
                    }
                ],
                "HealthCheck": {
                    "Target": "HTTP:80/",
                    "HealthyThreshold": "3",
                    "UnhealthyThreshold": "5",
                    "Interval": "30",
                    "Timeout": "5"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "8a2a2d4e-3ae0-4e90-8953-5bec2b66ab4d"
                }
            }
        },
        "FTPASG": {
            "Type": "AWS::AutoScaling::AutoScalingGroup",
            "CreationPolicy": {
                "ResourceSignal": {
                    "Timeout": "PT15M",
                    "Count": "2"
                }
            },
            "UpdatePolicy": {
                "AutoScalingRollingUpdate": {
                    "MaxBatchSize": "1",
                    "MinInstancesInService": "1",
                    "PauseTime": "PT15M",
                    "WaitOnResourceSignals": "true"
                }
            },
            "Properties": {
                "MinSize": "1",
                "MaxSize": "3",
                "LoadBalancerNames": [
                    {
                        "Ref": "FTPELB"
                    }
                ],
                "LaunchConfigurationName": {
                    "Ref": "FTPLC"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "2f57fed2-22be-4ec6-aa70-7cb7475efba2"
                }
            }
        },
        "LAMPASG": {
            "Type": "AWS::AutoScaling::AutoScalingGroup",
            "CreationPolicy": {
                "ResourceSignal": {
                    "Timeout": "PT15M",
                    "Count": "2"
                }
            },
            "UpdatePolicy": {
                "AutoScalingRollingUpdate": {
                    "MaxBatchSize": "1",
                    "MinInstancesInService": "1",
                    "PauseTime": "PT15M",
                    "WaitOnResourceSignals": "true"
                }
            },
            "Properties": {
                "MinSize": "1",
                "MaxSize": "3",
                "LoadBalancerNames": [
                    {
                        "Ref": "LAMPELB"
                    }
                ],
                "LaunchConfigurationName": {
                    "Ref": "LAMPLC"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "18415ed8-aeb7-407c-9ca1-b279130d9c27"
                }
            }
        },
        "FTPLC": {
            "Type": "AWS::AutoScaling::LaunchConfiguration",
            "Properties": {
                "SecurityGroups": [
                    {
                        "Ref": "FTPSG"
                    }
                ],
                "KeyName" : 
                    { 
                        "Ref" : "KeyName" 
                        
                    },
                "InstanceType" : 
                    { 
                        "Ref" : "InstanceType" 
                    }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "88aab4af-cd47-490a-b967-e5c211766512"
                }
            }
        },
        "LAMPLC": {
            "Type": "AWS::AutoScaling::LaunchConfiguration",
            "Properties": {
                "SecurityGroups": [
                    {
                        "Ref": "LAMPServerSG"
                    }
                ],
                "KeyName": {
                    "Ref": "KeyName"
                },
                "InstanceType": {
                    "Ref": "InstanceType"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "8c11f7cc-2d22-4f59-9019-f78aa5365107"
                }
            }
        }
    }
}