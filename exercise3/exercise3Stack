AWSTemplateFormatVersion: 2010-09-09
Description: Full stack for Exercise 3 of Globant's Cloud Academy
Parameters:
  AvailabilityZone:
    Type: String
    Default: us-west-1a
  KeyPair:
    Description: Choose the Key for SSH access
    Type: 'AWS::EC2::KeyPair::KeyName'
    MinLength: 1
    MaxLength: 255
    ConstraintDescription: Must specify a KeyPair
Mappings:
  RegionMap:
    us-east-1:
      AvailabilityZoneA: us-east-1e
      AvailabilityZoneB: us-east-1d
      AmznLinuxAmi: ami-b73b63a0
      CentOS7Ami: ami-6d1c2007
      RegionAlias: Virginia
    us-west-2:
      AvailabilityZoneA: us-west-2c
      AvailabilityZoneB: us-west-2b
      AmznLinuxAmi: ami-5ec1673e
      CentOS7Ami: ami-d2c924b2
      RegionAlias: Oregon
Resources:
  ElectionVPC:
    Type: 'AWS::EC2::VPC'
    Properties:
      CidrBlock: 10.0.0.0/16
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 93c2acf8-8702-48ca-bc99-32b392bb75a2
  ConsolidationSubnet:
    Type: 'AWS::EC2::Subnet'
    Properties:
      AvailabilityZone: !Ref AvailabilityZone
      CidrBlock: 10.0.2.0/24
      VpcId: !Ref ElectionVPC
      Tags:
        - Key: Name
          Value: ConsolidationSubnet
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 6d9d5454-7572-4445-b702-372dcbc2dae3

  DBsSubnet:
    Type: 'AWS::RDS::DBSubnetGroup'
    Properties: {}
    Metadata:
      'AWS::CloudFormation::Designer':
        id: a1aa7cb6-4f39-45e9-b61d-28a866e1fc26

##### START of Presentation #####

  PresentationSubnet:
    Type: 'AWS::EC2::Subnet'
    Properties:
      AvailabilityZone: !Ref AvailabilityZone
      CidrBlock: 10.0.3.0/24
      VpcId: !Ref ElectionVPC
      Tags:
        - Key: Name
          Value: PresentationSubnet
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 9e548083-a7a7-4ef4-afb2-344264a462dd
  PresentationInternetGateway:
    Type: 'AWS::EC2::InternetGateway'
    Properties: {}
  PresentationVPCGatewayAttachment:
    Type: 'AWS::EC2::VPCGatewayAttachment'
    Properties:
      InternetGatewayId: !Ref PresentationInternetGateway
      VpcId: !Ref ElectionVPC
  PresentationRouteTable:
    Type: 'AWS::EC2::RouteTable'
    Properties:
      VpcId: !Ref ElectionVPC
      Tags:
        - Key: Name
          Value: PresentationRouteTable
  PresentationOutboundConnectionRoute:
    Type: 'AWS::EC2::Route'
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref PresentationInternetGateway
      RouteTableId: !Ref ProctorsRouteTable
  PresentationSubnetRouteTableAssociation:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      RouteTableId: !Ref PresentationRouteTable
      SubnetId: !Ref PresentationSubnet
  PresentationSG:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      VpcId: !Ref ElectionVPC
      GroupDescription: Allows inbound http traffic
      SecurityGroupIngress:
        - CidrIp: 0.0.0.0/0
          FromPort: 443
          IpProtocol: tcp
          ToPort: 443
      Tags:
        - Key: Name
          Value: PresentationSG
  PresentationLoadBalancer:
    Type: 'AWS::ElasticLoadBalancing::LoadBalancer'
    Properties:
      LoadBalancerName: PresentationLoadBalancer
      Listeners:
        - InstancePort: 80
          InstanceProtocol: HTTP
          LoadBalancerPort: 80
          Protocol: HTTP
      Scheme: internet-facing
      SecurityGroups:
        - !Ref PresentationSG
      Subnets:
        - !Ref PresentationSubnet
  PresentationLaunchConfiguration:
    Type: 'AWS::AutoScaling::LaunchConfiguration'
    Properties:
      AssociatePublicIpAddress: true
      ImageId: !Ref ImageId
      InstanceType: t2.micro
      SecurityGroups: []
    DependsOn: PresentationVPCGatewayAttachment
  PresentationASG:
    Type: 'AWS::AutoScaling::AutoScalingGroup'
    Properties:
      AvailabilityZones:
        - !Ref AvailabilityZone
      DesiredCapacity: 1
      LaunchConfigurationName: !Ref PresentationLaunchConfiguration
      LoadBalancerNames:
        - !Ref PresentationLoadBalancer
      MaxSize: 2
      MinSize: 1
      VPCZoneIdentifier:
        - !Ref PresentationSubnet
    UpdatePolicy:
      AutoScalingRollingUpdate:
        MinInstancesInService: 1

##### END of Presentation #####

##### START of Proctors #####

  ProctorsSubnet:
    Type: 'AWS::EC2::Subnet'
    Properties:
      AvailabilityZone: !Ref AvailabilityZone
      CidrBlock: 10.0.1.0/24
      VpcId: !Ref ElectionVPC
      Tags:
        - Key: Name
          Value: ProctorsSubnet
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 450d73ed-3c6f-4a6f-92c1-a6f68a3a80ef
  ProctorsInternetGateway:
    Type: 'AWS::EC2::InternetGateway'
    Properties: {}
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 746fbe7c-3060-4f03-98a0-806622deb1f5
  ProctorsVPCGatewayAttachment:
    Type: 'AWS::EC2::VPCGatewayAttachment'
    Properties:
      InternetGatewayId: !Ref ProctorsInternetGateway
      VpcId: !Ref ElectionVPC
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 930c8d98-7643-4297-b491-45206c0f25be
  ProctorsRouteTable:
    Type: 'AWS::EC2::RouteTable'
    Properties:
      VpcId: !Ref ElectionVPC
      Tags:
        - Key: Name
          Value: ProctorsRouteTable
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 2d3ec719-c3d9-42d2-9d28-89a5684fd562
  ProctorsOutboundConnectionRoute:
    Type: 'AWS::EC2::Route'
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref ProctorsInternetGateway
      RouteTableId: !Ref ProctorsRouteTable
    Metadata:
      'AWS::CloudFormation::Designer':
        id: dc65f81e-53d7-46cb-b3c4-97bf67ff36fc
  ProctorsSubnetRouteTableAssociation:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      RouteTableId: !Ref ProctorsRouteTable
      SubnetId: !Ref ProctorsSubnet
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 8cfbef3f-8544-4aef-b49f-90336f15e58a
  ProctorsSG:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      VpcId: !Ref ElectionVPC
      GroupDescription: Allows inbound http traffic
      SecurityGroupIngress:
        - CidrIp: 0.0.0.0/0
          FromPort: 443
          IpProtocol: tcp
          ToPort: 443
      Tags:
        - Key: Name
          Value: ProctorsSG
    Metadata:
      'AWS::CloudFormation::Designer':
        id: ded1ecdc-11b3-4459-9128-aee13d3fea95
  ProctorsLoadBalancer:
    Type: 'AWS::ElasticLoadBalancing::LoadBalancer'
    Properties:
      LoadBalancerName: ProctorsLoadBalancer
      Listeners:
        - InstancePort: 80
          InstanceProtocol: HTTP
          LoadBalancerPort: 80
          Protocol: HTTP
      Scheme: internet-facing
      SecurityGroups:
        - !Ref ProctorsSG
      Subnets:
        - !Ref ProctorsSubnet
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 995a0a5a-c980-435e-baae-64804d4a8615
  ProctorsLaunchConfiguration:
    Type: 'AWS::AutoScaling::LaunchConfiguration'
    Properties:
      AssociatePublicIpAddress: true
      ImageId: !Ref ImageId
      InstanceType: t2.micro
      SecurityGroups: []
    DependsOn: ProctorsVPCGatewayAttachment
    Metadata:
      'AWS::CloudFormation::Designer':
        id: cfc4c732-e1d6-4dff-a1b9-6cad1635b7c2
  ProctorsASG:
    Type: 'AWS::AutoScaling::AutoScalingGroup'
    Properties:
      AvailabilityZones:
        - !Ref AvailabilityZone
      DesiredCapacity: 1
      LaunchConfigurationName: !Ref ProctorsLaunchConfiguration
      LoadBalancerNames:
        - !Ref ProctorsLoadBalancer
      MaxSize: 2
      MinSize: 1
      VPCZoneIdentifier:
        - !Ref ProctorsSubnet
    UpdatePolicy:
      AutoScalingRollingUpdate:
        MinInstancesInService: 1
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 641fd073-c642-4172-b223-16792644a1df

##### END OF Proctors #####

  ContentionBucket:
    Type: 'AWS::S3::Bucket'
    Properties: {}
    Metadata:
      'AWS::CloudFormation::Designer':
        id: 20b0008d-92b3-4278-b78d-3e5bf55e8051
Metadata:
  'AWS::CloudFormation::Designer':
    93c2acf8-8702-48ca-bc99-32b392bb75a2:
      size:
        width: 1470
        height: 660
      position:
        x: 100
        'y': -350
      z: 1
      embeds:
        - 20b0008d-92b3-4278-b78d-3e5bf55e8051
        - a1aa7cb6-4f39-45e9-b61d-28a866e1fc26
        - ded1ecdc-11b3-4459-9128-aee13d3fea95
        - 2d3ec719-c3d9-42d2-9d28-89a5684fd562
        - 450d73ed-3c6f-4a6f-92c1-a6f68a3a80ef
        - 9e548083-a7a7-4ef4-afb2-344264a462dd
        - 6d9d5454-7572-4445-b702-372dcbc2dae3
    450d73ed-3c6f-4a6f-92c1-a6f68a3a80ef:
      size:
        width: 150
        height: 150
      position:
        x: 210
        'y': 30
      z: 2
      parent: 93c2acf8-8702-48ca-bc99-32b392bb75a2
      embeds: []
    6d9d5454-7572-4445-b702-372dcbc2dae3:
      size:
        width: 150
        height: 150
      position:
        x: 1170
        'y': -170
      z: 2
      parent: 93c2acf8-8702-48ca-bc99-32b392bb75a2
      embeds: []
    9e548083-a7a7-4ef4-afb2-344264a462dd:
      size:
        width: 150
        height: 150
      position:
        x: 1350
        'y': 80
      z: 2
      parent: 93c2acf8-8702-48ca-bc99-32b392bb75a2
      embeds: []
    a1aa7cb6-4f39-45e9-b61d-28a866e1fc26:
      size:
        width: 150
        height: 120
      position:
        x: 1360
        'y': -120
      z: 2
      parent: 93c2acf8-8702-48ca-bc99-32b392bb75a2
      embeds: []
    20b0008d-92b3-4278-b78d-3e5bf55e8051:
      size:
        width: 60
        height: 60
      position:
        x: 1070
        'y': -50
      z: 2
      parent: 93c2acf8-8702-48ca-bc99-32b392bb75a2
      embeds: []
    746fbe7c-3060-4f03-98a0-806622deb1f5:
      size:
        width: 60
        height: 60
      position:
        x: -50
        'y': -60
      z: 1
      embeds: []
    ded1ecdc-11b3-4459-9128-aee13d3fea95:
      size:
        width: 60
        height: 60
      position:
        x: 410
        'y': 70
      z: 2
      parent: 93c2acf8-8702-48ca-bc99-32b392bb75a2
      embeds: []
    2d3ec719-c3d9-42d2-9d28-89a5684fd562:
      size:
        width: 120
        height: 150
      position:
        x: 230
        'y': -240
      z: 2
      parent: 93c2acf8-8702-48ca-bc99-32b392bb75a2
      embeds:
        - dc65f81e-53d7-46cb-b3c4-97bf67ff36fc
    dc65f81e-53d7-46cb-b3c4-97bf67ff36fc:
      size:
        width: 60
        height: 60
      position:
        x: 260
        'y': -200
      z: 3
      parent: 2d3ec719-c3d9-42d2-9d28-89a5684fd562
      embeds: []
    930c8d98-7643-4297-b491-45206c0f25be:
      source:
        id: 746fbe7c-3060-4f03-98a0-806622deb1f5
      target:
        id: 93c2acf8-8702-48ca-bc99-32b392bb75a2
    cfc4c732-e1d6-4dff-a1b9-6cad1635b7c2:
      size:
        width: 60
        height: 60
      position:
        x: 30
        'y': 340
      z: 1
      embeds: []
      dependson:
        - 930c8d98-7643-4297-b491-45206c0f25be
    995a0a5a-c980-435e-baae-64804d4a8615:
      size:
        width: 60
        height: 60
      position:
        x: 260
        'y': 340
      z: 1
      embeds: []
      isassociatedwith:
        - 450d73ed-3c6f-4a6f-92c1-a6f68a3a80ef
        - ded1ecdc-11b3-4459-9128-aee13d3fea95
    641fd073-c642-4172-b223-16792644a1df:
      size:
        width: 60
        height: 60
      position:
        x: 150
        'y': 340
      z: 1
      embeds: []
      isassociatedwith:
        - cfc4c732-e1d6-4dff-a1b9-6cad1635b7c2
        - 450d73ed-3c6f-4a6f-92c1-a6f68a3a80ef
        - 995a0a5a-c980-435e-baae-64804d4a8615
    8cfbef3f-8544-4aef-b49f-90336f15e58a:
      source:
        id: 2d3ec719-c3d9-42d2-9d28-89a5684fd562
      target:
        id: 450d73ed-3c6f-4a6f-92c1-a6f68a3a80ef
